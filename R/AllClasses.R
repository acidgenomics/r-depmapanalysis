## FIXME hasDimnames may need to be updated to FAIL if either rownames OR
## colnames are not assigned.



#' Sample metadata column names, defined in colData.
#'
#' @note Updated 2022-05-13.
#' @noRd
#'
#' @details
#' Not defined in "depmap_public_22q1":
#' - "achillesNReplicates"
#' - "cas9Activity"
#' - "cellLineNnmd"
#' - "cultureMedium"
#'
#' Not defined in "depmap_public_20q2":
#' - "wtsiMasterCellId"
#'
#' Not defined in "depmap_public_20q1":
#' - "cosmicid"
#' - "depmapPublicComments"
#' - "primaryDisease"
#' - "subtype"
.expectedColData <- c(
    "age",
    "alias",
    "ccleName",
    "cellLineName",
    "cultureType",
    "depMapId",
    "lineage",
    "lineageMolecularSubtype",
    "lineageSubSubtype",
    "lineageSubtype",
    "primaryOrMetastasis",
    "rrid",
    "sampleCollectionSite",
    "sangerModelId",
    "sex",
    "source",
    "strippedCellLineName"
)



#' Expected DataFrame metadata
#'
#' @note Updated 2022-03-09.
#' @noRd
.expectedDFMetadata <- list(
    "dataset" = "character",
    "date" = "Date",
    "packageName" = "character",
    "packageVersion" = "package_version"
)



#' Expected SummarizedExperiment metadata
#'
#' @note Updated 2022-06-03.
#' @noRd
.expectedSEMetadata <- append(
    x = .expectedDFMetadata,
    values = list(
        ## > "missingCells" = "character",
        ## > "retiredGenes" = "character",
        ## > "wd" = "character"
        "sessionInfo" = "sessionInfo"
    )
)



#' CCLE copy number data
#'
#' @details
#' Gene level copy number data, log2 transformed with a pseudo count of 1.
#' This is generated by mapping genes onto the segment level calls.
#'
#' Inherits from `SummarizedExperiment`.
#' Cells in columns, genes in rows.
#'
#' @export
#' @note Updated 2022-08-05.
#'
#' @return `CCLECopyNumberData`.
setClass(
    Class = "CCLECopyNumberData",
    contains = "SummarizedExperiment"
)
setValidity(
    Class = "CCLECopyNumberData",
    method = function(object) {
        ok <- validate(
            hasDimnames(object),
            allAreMatchingRegex(
                x = rownames(object),
                pattern = "^[_A-Za-z0-9]+_[0-9]+$"
            ),
            allAreMatchingRegex(
                x = colnames(object),
                pattern = "^ACH_[0-9]{6}$"
            ),
            isSubset("log2CopyNumber", assayNames(object)),
            isSubset(
                x = c(
                    ## > "xTaxId"
                    "chromosome",
                    "dbXrefs",
                    "description",
                    "featureType",
                    "geneId",
                    "geneName",
                    "geneSynonyms",
                    "mapLocation",
                    "modificationDate",
                    "nomenclatureStatus",
                    "otherDesignations",
                    "typeOfGene"
                ),
                y = colnames(rowData(object))
            ),
            areIntersectingSets(
                x = colnames(colData(object)),
                y = .expectedColData
            )
        )
        if (!isTRUE(ok)) {
            return(ok)
        }
        ok <- validateClasses(
            object = metadata(object),
            expected = .expectedSEMetadata,
            subset = TRUE
        )
        if (!isTRUE(ok)) {
            return(ok)
        }
        TRUE
    }
)



#' CCLE expression data
#'
#' @details
#'
#' RNA-seq TPM gene expression data for just protein coding genes using RSEM.
#' Log2 transformed, using a pseudo-count of 1.
#'
#' Inherits from `SummarizedExperiment`.
#' Cells in columns, genes in rows.
#'
#' @export
#' @note Updated 2022-08-05.
#'
#' @return `CCLEExpressionData`.
setClass(
    Class = "CCLEExpressionData",
    contains = "SummarizedExperiment"
)
setValidity(
    Class = "CCLEExpressionData",
    method = function(object) {
        ok <- validate(
            hasDimnames(object),
            allAreMatchingRegex(
                x = rownames(object),
                pattern = "^[_A-Za-z0-9]+_[0-9]+$"
            ),
            allAreMatchingRegex(
                x = colnames(object),
                pattern = "^ACH_[0-9]{6}$"
            ),
            isSubset("log2Tpm", assayNames(object)),
            isSubset(
                x = c(
                    ## > "xTaxId"
                    "chromosome",
                    "dbXrefs",
                    "description",
                    "featureType",
                    "geneId",
                    "geneName",
                    "geneSynonyms",
                    "mapLocation",
                    "modificationDate",
                    "nomenclatureStatus",
                    "otherDesignations",
                    "typeOfGene"
                ),
                y = colnames(rowData(object))
            ),
            areIntersectingSets(
                x = colnames(colData(object)),
                y = .expectedColData
            )
        )
        if (!isTRUE(ok)) {
            return(ok)
        }
        ok <- validateClasses(
            object = metadata(object),
            expected = .expectedSEMetadata,
            subset = TRUE
        )
        if (!isTRUE(ok)) {
            return(ok)
        }
        TRUE
    }
)



#' CCLE fusion data
#'
#' @details
#' Inherits from `DFrame`.
#'
#' @note Updated 2022-03-09.
#' @export
#'
#' @return `CCLEFusionData`.
setClass(
    Class = "CCLEFusionData",
    contains = "DFrame"
)
setValidity(
    Class = "CCLEFusionData",
    method = function(object) {
        ok <- validate(
            isSubset(
                x = c(
                    "annots",
                    "ccleCount",
                    "depMapId",
                    "ffpm",
                    "fusionName",
                    "junctionReadCount",
                    "largeAnchorSupport",
                    "leftBreakDinuc",
                    "leftBreakEntropy",
                    "leftBreakpoint",
                    "leftGene",
                    "rightBreakDinuc",
                    "rightBreakEntropy",
                    "rightBreakpoint",
                    "rightGene",
                    "spanningFragCount",
                    "spliceType"
                ),
                y = colnames(object)
            )
        )
        if (!isTRUE(ok)) {
            return(ok)
        }
        ok <- validateClasses(
            object = metadata(object),
            expected = append(
                x = .expectedDFMetadata,
                values = list(
                    "filtered" = "logical"
                )
            ),
            subset = TRUE
        )
        if (!isTRUE(ok)) {
            return(ok)
        }
        TRUE
    }
)



#' CCLE mutation data
#'
#' @details
#' Inherits from `DFrame`.
#'
#' @note Updated 2022-05-13.
#' @export
#'
#' @return `CCLEMutationData`.
setClass(
    Class = "CCLEMutationData",
    contains = "DFrame"
)
setValidity(
    Class = "CCLEMutationData",
    method = function(object) {
        ok <- validate(
            isSubset(
                x = c(
                    ## > "tumorSeqAllele1"
                    "annotationTranscript",
                    "cDnaChange",
                    "cgaWesAc",
                    "chromosome",
                    "codonChange",
                    "cosmiChsCnt",
                    "dbSnpRs",
                    "dbSnpValStatus",
                    "depMapId",
                    "endPosition",
                    "entrezGeneId",
                    "exAcAf",
                    "genomeChange",
                    "hcAc",
                    "hugoSymbol",
                    "isCosmiChotspot",
                    "isDeleterious",
                    "isTcgAhotspot",
                    "ncbiBuild",
                    "proteinChange",
                    "rdAc",
                    "referenceAllele",
                    "rnAseqAc",
                    "sangerWesAc",
                    "startPosition",
                    "strand",
                    "tcgAhsCnt",
                    "variantAnnotation",
                    "variantClassification",
                    "variantType",
                    "wgsAc"
                ),
                y = colnames(object)
            )
        )
        if (!isTRUE(ok)) {
            return(ok)
        }
        ok <- validateClasses(
            object = metadata(object),
            expected = .expectedDFMetadata,
            subset = TRUE
        )
        if (!isTRUE(ok)) {
            return(ok)
        }
        TRUE
    }
)



#' Gene effect co-dependencies
#'
#' @details
#' Inherits from `DataFrame`.
#'
#' @note Updated 2022-08-05.
#' @export
#'
#' @return `Codependencies`.
setClass(
    Class = "Codependencies",
    contains = "DFrame"
)
setValidity(
    Class = "Codependencies",
    method = function(object) {
        ok <- validate(
            identical(
                x = c(
                    "geneName1",
                    "geneName2",
                    "pearson"
                ),
                y = colnames(object)
            )
        )
        if (!isTRUE(ok)) {
            return(ok)
        }
        ok <- validateClasses(
            object = metadata(object),
            expected = .expectedDFMetadata,
            subset = TRUE
        )
        if (!isTRUE(ok)) {
            return(ok)
        }
        TRUE
    }
)



#' Gene effect in cancer cell lines
#'
#' @details
#' Inherits from `SummarizedExperiment`.
#' Cells in columns, genes in rows.
#'
#' @export
#' @note Updated 2022-08-05.
#'
#' @return `GeneEffect`.
#'
#' @seealso
#' - https://depmap.org/portal/achilles/
#' - https://depmap.org/ceres/
#' - https://score.depmap.sanger.ac.uk/
setClass(
    Class = "GeneEffect",
    contains = "SummarizedExperiment"
)
setValidity(
    Class = "GeneEffect",
    method = function(object) {
        ok <- validate(
            hasDimnames(object),
            allAreMatchingRegex(
                x = rownames(object),
                pattern = "^[_A-Za-z0-9]+_[0-9]+$"
            ),
            allAreMatchingRegex(
                x = colnames(object),
                pattern = "^ACH_[0-9]{6}$"
            ),
            isSubset("effect", assayNames(object))
        )
        if (!isTRUE(ok)) {
            return(ok)
        }
        ok <- validateClasses(
            object = metadata(object),
            expected = append(
                x = .expectedSEMetadata,
                values = list(
                    "libraryType" = "character",
                    "project" = "character",
                    "scoringMethod" = "character"
                )
            ),
            subset = TRUE
        )
        if (!isTRUE(ok)) {
            return(ok)
        }
        switch(
            EXPR = metadata(object)[["libraryType"]],
            "crispr" = {
                ok <- validate(
                    isSubset("probability", assayNames(object)),
                    areIntersectingSets(
                        x = colnames(colData(object)),
                        y = .expectedColData
                    )
                )
                if (!isTRUE(ok)) {
                    return(ok)
                }
                ok <- validateClasses(
                    object = metadata(object),
                    expected = list(
                        "commonEssentials" = "character",
                        "controlCommonEssentials" = "character",
                        "controlNonessentials" = "character"
                    ),
                    subset = TRUE
                )
                if (!isTRUE(ok)) {
                    return(ok)
                }
            },
            "rnai" = {
                ok <- validate(
                    areIntersectingSets(
                        x = colnames(colData(object)),
                        y = .expectedColData
                    ),
                    isSubset(
                        x = c(
                            "inAchilles",
                            "inDrive",
                            "inMarcotte",
                            "marcotteName",
                            "marcotteSubtypeIntrinsic",
                            "marcotteSubtypeNeve",
                            "marcotteSubtypeThreeReceptor",
                            "novartisName",
                            "novartisPathologistAnnotation",
                            "novartisPrimarySite"
                        ),
                        y = colnames(colData(object))
                    )
                )
                if (!isTRUE(ok)) {
                    return(ok)
                }
            }
        )
        TRUE
    }
)
